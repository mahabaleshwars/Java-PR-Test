name: Test Configuration Cache

on: 
  push: 
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  # Scenario: Configuration cache with encryption key
  configuration-cache-basic:
    name:  Configuration Cache Basic
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution:  temurin
          java-version: 17

      - name: Setup Gradle with configuration cache
        uses:  gradle/actions/setup-gradle@v5
        with:
          gradle-version: '8.6'
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name:  Build with configuration cache
        run: gradle build --configuration-cache

  # Scenario: Configuration cache with different Gradle versions
  configuration-cache-gradle-versions:
    name: Config Cache - Gradle ${{ matrix.gradle-version }}
    strategy:
      fail-fast: false
      matrix:
        gradle-version:  ['8.6', '8.7', '8.8', '8.9', '8.10']
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution:  temurin
          java-version: 17

      - name: Setup Gradle ${{ matrix.gradle-version }} with config cache
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: ${{ matrix.gradle-version }}
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name:  Build with configuration cache
        run:  gradle build --configuration-cache

  # Scenario: Configuration cache on multiple platforms
  configuration-cache-multiplatform:
    name: Config Cache - ${{ matrix.os }}
    strategy: 
      matrix:
        os:  [ubuntu-latest, macos-latest, windows-latest]
    runs-on:  ${{ matrix.os }}
    steps: 
      - uses:  actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle with configuration cache
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: '8.10'
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Build with configuration cache
        run: gradle build --configuration-cache